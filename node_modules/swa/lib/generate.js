'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; /**
                                                                                                                                                                                                                                                                               * @file Description
                                                                                                                                                                                                                                                                               * @author ielgnaw(wuji0223@gmail.com)
                                                                                                                                                                                                                                                                               */

exports.setDefault = setDefault;

exports.default = function (curPrompts, projectName, inCurrent) {
    var dest = inCurrent ? '.' : projectName;
    var metalsmith = new _metalsmith2.default((0, _path.join)(__dirname, './template')).source('.');
    metalsmith.use(ask(curPrompts)).use(filterFiles).use(renderTemplate).clean(false).destination((0, _path.join)(process.cwd(), dest)).build(function (err) {
        if (err) {
            throw err;
        }

        var curDependencies = _extends({}, _meta2.default.ALL_DEPENDENCIES);

        var metadata = metalsmith.metadata();
        console.log('metadata', metadata);

        if (metadata.redis) {
            curDependencies.save.push('redis');
        }

        if (metadata.auth === 'uuap') {
            curDependencies.saveDev.push('jsonwebtoken');
        }

        process.chdir(dest);

        (0, _npmInstall2.default)(_meta2.default.ALL_DEPENDENCIES, function () {
            console.log('all deps install done\n');
            console.log('Please complete your profile:\n');
        });
    });
};

var _path = require('path');

var _inquirer = require('inquirer');

var _inquirer2 = _interopRequireDefault(_inquirer);

var _async = require('async');

var _async2 = _interopRequireDefault(_async);

var _metalsmith = require('metalsmith');

var _metalsmith2 = _interopRequireDefault(_metalsmith);

var _consolidate = require('consolidate');

var _consolidate2 = _interopRequireDefault(_consolidate);

var _npmInstall = require('./npm-install');

var _npmInstall2 = _interopRequireDefault(_npmInstall);

var _meta = require('./meta');

var _meta2 = _interopRequireDefault(_meta);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var RENDER = _consolidate2.default.handlebars.render;

/**
 * metalsmith plugin repl
 *
 * @param {Object} curPrompts 当前的提示问题
 */
var ask = function ask(curPrompts) {
    return function (files, metalsmith, done) {
        var metadata = metalsmith.metadata();

        _async2.default.eachSeries(Object.keys(curPrompts), function (key, next) {
            run(metadata, key, curPrompts[key], next);
        }, done);

        function run(data, key, prompt, done) {
            var _this = this;

            if (key === 'separator') {
                console.log('\n---- ' + prompt.message + ' set (Now we only support MySQL) ----');
                return done();
            }

            var promptDefault = prompt.default;
            if (typeof prompt.default === 'function') {
                promptDefault = function promptDefault() {
                    return prompt.default.bind(_this)(data);
                };
            }

            _inquirer2.default.prompt([{
                type: prompt.type,
                name: key,
                message: prompt.message || prompt.label || key,
                default: promptDefault,
                choices: prompt.choices || [],
                validate: prompt.validate || function () {
                    return true;
                },
                filter: prompt.filter || function () {}
            }]).then(function (answers) {
                if (Array.isArray(answers[key])) {
                    data[key] = {};
                    answers[key].forEach(function (multiChoiceAnswer) {
                        data[key][multiChoiceAnswer] = true;
                    });
                } else if (typeof answers[key] === 'string') {
                    data[key] = answers[key].replace(/"/g, '\\"');
                } else {
                    data[key] = answers[key];
                }

                done();
            });
        }
    };
};

/**
 * metalsmith plugin 渲染模板
 *
 * @param {Object} files files 对象
 * @param {Object} metalsmith metalsmith 实例对象
 * @param {Function} done 完成回调函数
 */
var renderTemplate = function renderTemplate(files, metalsmith, done) {
    var keys = Object.keys(files);
    var metadata = metalsmith.metadata();

    _async2.default.each(keys, run, done);

    function run(file, done) {
        var str = files[file].contents.toString();
        RENDER(str, metadata, function (err, res) {
            if (err) {
                return done(err);
            }
            files[file].contents = new Buffer(res);
            done();
        });
    }
};

/**
 * 设置提示问题的默认值
 *
 * @param {Object} prompts 提示问题
 * @param {string} key 提示问题的 key
 * @param {string} val 提示问题的 value
 */
function setDefault(prompts, key, val) {
    if (!prompts[key] || _typeof(prompts[key]) !== 'object') {
        prompts[key] = {
            type: 'input',
            default: val
        };
    } else {
        prompts[key]['default'] = val;
    }
}

/**
 * metalsmith plugin 过滤文件，把一些根据命令行选择项参数的文件过滤掉
 *
 * @param {Object} files files 对象
 * @param {Object} metalsmith metalsmith 实例对象
 * @param {Function} done 完成回调函数
 */
function filterFiles(files, metalsmith, done) {
    var metadata = metalsmith.metadata();
    if (!metadata.redis) {
        delete files['server/conf/redis.js'];
    }
    if (!metadata.uuap) {
        delete files['server/conf/uuap.js'];
    }
    done();
}

/**
 * generate project
 *
 * @param {Object} curPrompts 当前的提示问题
 * @param {string} projectName 项目名称
 * @param {boolean} inCurrent 是否在当前目录直接创建项目
 */
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9nZW5lcmF0ZS5qcyJdLCJuYW1lcyI6WyJzZXREZWZhdWx0IiwiY3VyUHJvbXB0cyIsInByb2plY3ROYW1lIiwiaW5DdXJyZW50IiwiZGVzdCIsIm1ldGFsc21pdGgiLCJfX2Rpcm5hbWUiLCJzb3VyY2UiLCJ1c2UiLCJhc2siLCJmaWx0ZXJGaWxlcyIsInJlbmRlclRlbXBsYXRlIiwiY2xlYW4iLCJkZXN0aW5hdGlvbiIsInByb2Nlc3MiLCJjd2QiLCJidWlsZCIsImVyciIsImN1ckRlcGVuZGVuY2llcyIsIkFMTF9ERVBFTkRFTkNJRVMiLCJtZXRhZGF0YSIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcyIsInNhdmUiLCJwdXNoIiwiYXV0aCIsInNhdmVEZXYiLCJjaGRpciIsIlJFTkRFUiIsImhhbmRsZWJhcnMiLCJyZW5kZXIiLCJmaWxlcyIsImRvbmUiLCJlYWNoU2VyaWVzIiwiT2JqZWN0Iiwia2V5cyIsImtleSIsIm5leHQiLCJydW4iLCJkYXRhIiwicHJvbXB0IiwibWVzc2FnZSIsInByb21wdERlZmF1bHQiLCJkZWZhdWx0IiwiYmluZCIsInR5cGUiLCJuYW1lIiwibGFiZWwiLCJjaG9pY2VzIiwidmFsaWRhdGUiLCJmaWx0ZXIiLCJ0aGVuIiwiQXJyYXkiLCJpc0FycmF5IiwiYW5zd2VycyIsImZvckVhY2giLCJtdWx0aUNob2ljZUFuc3dlciIsInJlcGxhY2UiLCJlYWNoIiwiZmlsZSIsInN0ciIsImNvbnRlbnRzIiwidG9TdHJpbmciLCJyZXMiLCJCdWZmZXIiLCJwcm9tcHRzIiwidmFsIiwidXVhcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OFFBQUE7Ozs7O1FBb0dnQkEsVSxHQUFBQSxVOztrQkFxQ0QsVUFBU0MsVUFBVCxFQUFxQkMsV0FBckIsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3hELFFBQU1DLE9BQU9ELFlBQVksR0FBWixHQUFrQkQsV0FBL0I7QUFDQSxRQUFNRyxhQUFhLHlCQUFlLGdCQUFLQyxTQUFMLEVBQWdCLFlBQWhC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LEVBQVlFLFFBQVosR0FBdUIsSUFBSUcsTUFBSixDQUFXRCxHQUFYLENBQXZCO0FBQ0EvQjtBQUNILFNBTkQ7QUFPSDtBQUNKLENBaEJEOztBQW1CQTs7Ozs7OztBQU9PLFNBQVNqQyxVQUFULENBQW9Ca0UsT0FBcEIsRUFBNkI3QixHQUE3QixFQUFrQzhCLEdBQWxDLEVBQXVDO0FBQzFDLFFBQUksQ0FBQ0QsUUFBUTdCLEdBQVIsQ0FBRCxJQUFpQixRQUFPNkIsUUFBUTdCLEdBQVIsQ0FBUCxNQUF3QixRQUE3QyxFQUF1RDtBQUNuRDZCLGdCQUFRN0IsR0FBUixJQUFlO0FBQ1hTLGtCQUFNLE9BREs7QUFFWEYscUJBQVN1QjtBQUZFLFNBQWY7QUFJSCxLQUxELE1BTUs7QUFDREQsZ0JBQVE3QixHQUFSLEVBQWEsU0FBYixJQUEwQjhCLEdBQTFCO0FBQ0g7QUFDSjs7QUFFRDs7Ozs7OztBQU9BLFNBQVN6RCxXQUFULENBQXFCc0IsS0FBckIsRUFBNEIzQixVQUE1QixFQUF3QzRCLElBQXhDLEVBQThDO0FBQzFDLFFBQU1iLFdBQVdmLFdBQVdlLFFBQVgsRUFBakI7QUFDQSxRQUFJLENBQUNBLFNBQVNHLEtBQWQsRUFBcUI7QUFDakIsZUFBT1MsTUFBTSxzQkFBTixDQUFQO0FBQ0g7QUFDRCxRQUFJLENBQUNaLFNBQVNnRCxJQUFkLEVBQW9CO0FBQ2hCLGVBQU9wQyxNQUFNLHFCQUFOLENBQVA7QUFDSDtBQUNEQztBQUNIOztBQUVEIiwiZmlsZSI6ImdlbmVyYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBEZXNjcmlwdGlvblxuICogQGF1dGhvciBpZWxnbmF3KHd1amkwMjIzQGdtYWlsLmNvbSlcbiAqL1xuXG5pbXBvcnQge2pvaW59IGZyb20gJ3BhdGgnO1xuaW1wb3J0IGlucXVpcmVyIGZyb20gJ2lucXVpcmVyJztcbmltcG9ydCBhc3luYyBmcm9tICdhc3luYyc7XG5pbXBvcnQgTWV0YWxzbWl0aCBmcm9tICdtZXRhbHNtaXRoJztcbmltcG9ydCBjb25zb2xpZGF0ZSBmcm9tICdjb25zb2xpZGF0ZSc7XG5pbXBvcnQgbnBtSW5zdGFsbCBmcm9tICcuL25wbS1pbnN0YWxsJztcbmltcG9ydCBtZXRhIGZyb20gJy4vbWV0YSc7XG5cbmNvbnN0IFJFTkRFUiA9IGNvbnNvbGlkYXRlLmhhbmRsZWJhcnMucmVuZGVyO1xuXG4vKipcbiAqIG1ldGFsc21pdGggcGx1Z2luIHJlcGxcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gY3VyUHJvbXB0cyDlvZPliY3nmoTmj5DnpLrpl67pophcbiAqL1xuY29uc3QgYXNrID0gY3VyUHJvbXB0cyA9PiB7XG4gICAgcmV0dXJuIChmaWxlcywgbWV0YWxzbWl0aCwgZG9uZSkgPT4ge1xuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IG1ldGFsc21pdGgubWV0YWRhdGEoKTtcblxuICAgICAgICBhc3luYy5lYWNoU2VyaWVzKE9iamVjdC5rZXlzKGN1clByb21wdHMpLCAoa2V5LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBydW4obWV0YWRhdGEsIGtleSwgY3VyUHJvbXB0c1trZXldLCBuZXh0KTtcbiAgICAgICAgfSwgZG9uZSk7XG5cbiAgICAgICAgZnVuY3Rpb24gcnVuKGRhdGEsIGtleSwgcHJvbXB0LCBkb25lKSB7XG4gICAgICAgICAgICBpZiAoa2V5ID09PSAnc2VwYXJhdG9yJykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBcXG4tLS0tICR7cHJvbXB0Lm1lc3NhZ2V9IHNldCAoTm93IHdlIG9ubHkgc3VwcG9ydCBNeVNRTCkgLS0tLWApO1xuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBwcm9tcHREZWZhdWx0ID0gcHJvbXB0LmRlZmF1bHQ7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHByb21wdC5kZWZhdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdCA9ICgpID0+IHByb21wdC5kZWZhdWx0LmJpbmQodGhpcykoZGF0YSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlucXVpcmVyLnByb21wdChbe1xuICAgICAgICAgICAgICAgIHR5cGU6IHByb21wdC50eXBlLFxuICAgICAgICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBwcm9tcHQubWVzc2FnZSB8fCBwcm9tcHQubGFiZWwgfHwga2V5LFxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHByb21wdERlZmF1bHQsXG4gICAgICAgICAgICAgICAgY2hvaWNlczogcHJvbXB0LmNob2ljZXMgfHwgW10sXG4gICAgICAgICAgICAgICAgdmFsaWRhdGU6IHByb21wdC52YWxpZGF0ZSB8fCAoKCkgPT4gdHJ1ZSksXG4gICAgICAgICAgICAgICAgZmlsdGVyOiBwcm9tcHQuZmlsdGVyIHx8ICgoKSA9PiB7fSlcbiAgICAgICAgICAgIH1dKS50aGVuKGFuc3dlcnMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFuc3dlcnNba2V5XSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0ge307XG4gICAgICAgICAgICAgICAgICAgIGFuc3dlcnNba2V5XS5mb3JFYWNoKG11bHRpQ2hvaWNlQW5zd2VyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFba2V5XVttdWx0aUNob2ljZUFuc3dlcl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGFuc3dlcnNba2V5XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gYW5zd2Vyc1trZXldLnJlcGxhY2UoL1wiL2csICdcXFxcXCInKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IGFuc3dlcnNba2V5XTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG59O1xuXG4vKipcbiAqIG1ldGFsc21pdGggcGx1Z2luIOa4suafk+aooeadv1xuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlcyBmaWxlcyDlr7nosaFcbiAqIEBwYXJhbSB7T2JqZWN0fSBtZXRhbHNtaXRoIG1ldGFsc21pdGgg5a6e5L6L5a+56LGhXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBkb25lIOWujOaIkOWbnuiwg+WHveaVsFxuICovXG5jb25zdCByZW5kZXJUZW1wbGF0ZSA9IChmaWxlcywgbWV0YWxzbWl0aCwgZG9uZSkgPT4ge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhmaWxlcyk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSBtZXRhbHNtaXRoLm1ldGFkYXRhKCk7XG5cbiAgICBhc3luYy5lYWNoKGtleXMsIHJ1biwgZG9uZSk7XG5cbiAgICBmdW5jdGlvbiBydW4oZmlsZSwgZG9uZSkge1xuICAgICAgICBjb25zdCBzdHIgPSBmaWxlc1tmaWxlXS5jb250ZW50cy50b1N0cmluZygpO1xuICAgICAgICBSRU5ERVIoc3RyLCBtZXRhZGF0YSwgKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZpbGVzW2ZpbGVdLmNvbnRlbnRzID0gbmV3IEJ1ZmZlcihyZXMpO1xuICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuXG5cbi8qKlxuICog6K6+572u5o+Q56S66Zeu6aKY55qE6buY6K6k5YC8XG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHByb21wdHMg5o+Q56S66Zeu6aKYXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IOaPkOekuumXrumimOeahCBrZXlcbiAqIEBwYXJhbSB7c3RyaW5nfSB2YWwg5o+Q56S66Zeu6aKY55qEIHZhbHVlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXREZWZhdWx0KHByb21wdHMsIGtleSwgdmFsKSB7XG4gICAgaWYgKCFwcm9tcHRzW2tleV0gfHwgdHlwZW9mIHByb21wdHNba2V5XSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgcHJvbXB0c1trZXldID0ge1xuICAgICAgICAgICAgdHlwZTogJ2lucHV0JyxcbiAgICAgICAgICAgIGRlZmF1bHQ6IHZhbFxuICAgICAgICB9O1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcHJvbXB0c1trZXldWydkZWZhdWx0J10gPSB2YWw7XG4gICAgfVxufVxuXG4vKipcbiAqIG1ldGFsc21pdGggcGx1Z2luIOi/h+a7pOaWh+S7tu+8jOaKiuS4gOS6m+agueaNruWRveS7pOihjOmAieaLqemhueWPguaVsOeahOaWh+S7tui/h+a7pOaOiVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlcyBmaWxlcyDlr7nosaFcbiAqIEBwYXJhbSB7T2JqZWN0fSBtZXRhbHNtaXRoIG1ldGFsc21pdGgg5a6e5L6L5a+56LGhXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBkb25lIOWujOaIkOWbnuiwg+WHveaVsFxuICovXG5mdW5jdGlvbiBmaWx0ZXJGaWxlcyhmaWxlcywgbWV0YWxzbWl0aCwgZG9uZSkge1xuICAgIGNvbnN0IG1ldGFkYXRhID0gbWV0YWxzbWl0aC5tZXRhZGF0YSgpO1xuICAgIGlmICghbWV0YWRhdGEucmVkaXMpIHtcbiAgICAgICAgZGVsZXRlIGZpbGVzWydzZXJ2ZXIvY29uZi9yZWRpcy5qcyddO1xuICAgIH1cbiAgICBpZiAoIW1ldGFkYXRhLnV1YXApIHtcbiAgICAgICAgZGVsZXRlIGZpbGVzWydzZXJ2ZXIvY29uZi91dWFwLmpzJ107XG4gICAgfVxuICAgIGRvbmUoKTtcbn1cblxuLyoqXG4gKiBnZW5lcmF0ZSBwcm9qZWN0XG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGN1clByb21wdHMg5b2T5YmN55qE5o+Q56S66Zeu6aKYXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvamVjdE5hbWUg6aG555uu5ZCN56ewXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGluQ3VycmVudCDmmK/lkKblnKjlvZPliY3nm67lvZXnm7TmjqXliJvlu7rpobnnm65cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oY3VyUHJvbXB0cywgcHJvamVjdE5hbWUsIGluQ3VycmVudCkge1xuICAgIGNvbnN0IGRlc3QgPSBpbkN1cnJlbnQgPyAnLicgOiBwcm9qZWN0TmFtZTtcbiAgICBjb25zdCBtZXRhbHNtaXRoID0gbmV3IE1ldGFsc21pdGgoam9pbihfX2Rpcm5hbWUsICcuL3RlbXBsYXRlJykpLnNvdXJjZSgnLicpO1xuICAgIG1ldGFsc21pdGhcbiAgICAgICAgLnVzZShhc2soY3VyUHJvbXB0cykpXG4gICAgICAgIC51c2UoZmlsdGVyRmlsZXMpXG4gICAgICAgIC51c2UocmVuZGVyVGVtcGxhdGUpXG4gICAgICAgIC5jbGVhbihmYWxzZSlcbiAgICAgICAgLmRlc3RpbmF0aW9uKGpvaW4ocHJvY2Vzcy5jd2QoKSwgZGVzdCkpXG4gICAgICAgIC5idWlsZChlcnIgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY3VyRGVwZW5kZW5jaWVzID0gT2JqZWN0LmFzc2lnbih7fSwgbWV0YS5BTExfREVQRU5ERU5DSUVTKTtcblxuICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBtZXRhbHNtaXRoLm1ldGFkYXRhKCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnbWV0YWRhdGEnLCBtZXRhZGF0YSk7XG5cbiAgICAgICAgICAgIGlmIChtZXRhZGF0YS5yZWRpcykge1xuICAgICAgICAgICAgICAgIGN1ckRlcGVuZGVuY2llcy5zYXZlLnB1c2goJ3JlZGlzJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChtZXRhZGF0YS5hdXRoID09PSAndXVhcCcpIHtcbiAgICAgICAgICAgICAgICBjdXJEZXBlbmRlbmNpZXMuc2F2ZURldi5wdXNoKCdqc29ud2VidG9rZW4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcHJvY2Vzcy5jaGRpcihkZXN0KTtcblxuICAgICAgICAgICAgbnBtSW5zdGFsbChtZXRhLkFMTF9ERVBFTkRFTkNJRVMsICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYWxsIGRlcHMgaW5zdGFsbCBkb25lXFxuJyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1BsZWFzZSBjb21wbGV0ZSB5b3VyIHByb2ZpbGU6XFxuJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG59XG4iXX0=